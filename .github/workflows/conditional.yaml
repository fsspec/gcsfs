name: Conditional GCB Gatekeeper

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # This single job will be our required status check.
  gcb-gatekeeper:
    # Only run on comments made on a pull request, or on the PR event itself.
    if: github.event_name == 'pull_request' || github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      # These permissions are required for authentication and checking out code.
      contents: 'read'
      id-token: 'write'

    steps:
      # Step 1: Check for the '/gcbrun' comment.
      # This step sets an output that the next steps will use to decide whether to run.
      - name: Check for /gcbrun comment
        id: check_comment
        uses: actions/github-script@v7
        with:
          script: |
            // Default to not running the build
            let runBuild = false;
            // If the event is a comment, check its content
            if (context.eventName === 'issue_comment') {
              const comment = context.payload.comment.body;
              if (comment.includes('/gcbrun')) {
                runBuild = true;
              }
            }
            // Set the output for subsequent steps
            core.setOutput('run_build', runBuild);

      # The following steps will only run if the '/gcbrun' comment was found.
      - name: 'Checkout code'
        if: steps.check_comment.outputs.run_build == 'true'
        uses: actions/checkout@v3

      # Step 3: Trigger the Google Cloud Build and WAIT.
      # The '--wait' flag is the most critical part of this solution.
      # It pauses this workflow until the Cloud Build completes. The workflow
      # will then fail if the build fails, correctly blocking the merge.
      - name: Trigger and wait for Google Cloud Build
        if: steps.check_comment.outputs.run_build == 'true'
        run: |
          echo "Build triggered by /gcbrun. Waiting for result..."
          gcloud builds submit . --config cloudbuild.yaml --wait
