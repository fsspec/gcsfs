name: Conditional GCBrin Check

on:
  pull_request:
    types: [opened, synchronize, edited, reopened,]

jobs:
  check_gcbrun_comment:
    runs-on: ubuntu-latest
    outputs:
      gcbrun_requested: ${{ steps.check.outputs.gcbrun_requested }}
    steps:
      - name: Check for /gcbrun comment
        id: check
        run: |
          # Get the PR body and all comments
          PR_TEXT="${{ github.event.pull_request.body }}"
          # You may need a more advanced logic to fetch comments via the GitHub API
          # For simplicity, we often check the PR body or title on pull_request events.

          if [[ "$PR_TEXT" == *"/gcbrun"* ]]; then
            echo "gcbrun_requested=true" >> $GITHUB_OUTPUT
          else
            echo "gcbrun_requested=false" >> $GITHUB_OUTPUT
          fi

      - name: Set Status to Success if /gcbrun is NOT requested
        # This step runs ONLY if the comment is NOT present.
        if: steps.check.outputs.gcbrun_requested == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            // Post a successful status for the required check
            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'amaloo-gcsfs-v2', // The exact check name required by Branch Protection
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'GCB Not Required',
                summary: 'The /gcbrun command was not found. Merge is allowed.',
              }
            });
      - name: Post Initial PENDING Status (if GCB IS requested)
        # This step runs ONLY if the command WAS found, indicating GCB will run.
        if: steps.check.outputs.gcbrun_requested == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'amaloo-gcsfs-v2', // THIS MUST BE THE EXACT NAME GCB USES
              head_sha: context.payload.pull_request.head.sha,
              status: 'in_progress', // Set the status to pending
              output: {
                title: 'GCB Execution Requested',
                summary: 'The /gcbrun command was found. Waiting for Google Cloud Build status...',
              }
            });
