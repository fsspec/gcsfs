name: Conditional GCB Gatekeeper

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  # This single job will be our required status check.
  gcb-gatekeeper:
    # Only run on comments that are on a pull request, or on the PR event itself.
    if: github.event_name == 'pull_request' || github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # Required for authenticating to Google Cloud

    steps:
      # Step 1: Check if the triggering event is a PR comment that contains '/gcbrun'.
      # The 'id' gives this step a name we can reference later.
      - name: Check for /gcbrun comment
        id: check_comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            if (comment.includes('/gcbrun')) {
              // This output is set to 'true' only if the comment is found.
              core.setOutput('run_build', 'true');
            }

      # If the comment is found, the 'run_build' output will be true. If not, this step is skipped.
      - name: 'Checkout code'
        if: steps.check_comment.outputs.run_build == 'true'
        uses: actions/checkout@v3


      # Step 3: Trigger the build. This step also only runs if the comment was found.
      # The '--wait' flag is critical. It makes the action wait for the build to complete.
      # The action will then fail if the build fails, which fails the whole job.
      - name: Trigger and wait for Google Cloud Build
        if: steps.check_comment.outputs.run_build == 'true'
        run: |
          echo "Build triggered by /gcbrun comment. Waiting for result..."
          gcloud builds submit . --config cloudbuild.yaml --wait

