name: GCB Gatekeeper

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  # This single job will be our required status check.
  gcb-gatekeeper:
    # Only run this job if the event is a PR or a comment on a PR.
    if: github.event_name == 'pull_request' || github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      # This permission is required to read checks and comments.
      checks: 'read'
      contents: 'read'

    steps:
      - name: Track GCB status on /gcbrun
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.issue.number;
            const checkName = 'amaloo-gcsfs-v2 (gcs-aiml-clients-testing-101)'; // The exact name of the GCB check

            // 1. Check if the /gcbrun command exists in any comment
            console.log('Checking for /gcbrun comment...');
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            const runRequested = comments.some(comment => comment.body.includes('/gcbrun'));

            if (!runRequested) {
              console.log('No /gcbrun comment found. This check is successful.');
              return; // Exit successfully, allowing merge
            }

            console.log('/gcbrun comment found. Tracking the build status...');

            // 2. If command exists, track the status of the Cloud Build check
            const headSha = context.payload.pull_request ? context.payload.pull_request.head.sha : context.payload.issue.pull_request.head.sha;
            const timeoutMinutes = 15;
            const pollIntervalSeconds = 30;
            const startTime = Date.now();

            while (Date.now() - startTime < timeoutMinutes * 60 * 1000) {
              const { data: checks } = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: headSha,
                check_name: checkName,
              });

              const gcbCheck = checks.check_runs[0];

              if (gcbCheck && gcbCheck.status === 'completed') {
                if (gcbCheck.conclusion === 'success') {
                  console.log(`'${checkName}' completed successfully.`);
                  return; // Success, allow merge
                } else {
                  core.setFailed(`'${checkName}' failed with conclusion: ${gcbCheck.conclusion}.`);
                  return; // Failure, block merge
                }
              }

              console.log(`'${checkName}' is pending... Polling again in ${pollIntervalSeconds}s.`);
              await new Promise(r => setTimeout(r, pollIntervalSeconds * 1000));
            }

            core.setFailed(`Timed out after ${timeoutMinutes} minutes waiting for '${checkName}' to complete.`);
