name: GCB Gatekeeper

on:
  push:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]
  workflow_dispatch:


jobs:
  # This single job will be our required status check.
  gcb-gatekeeper:
    # Only run this job if the event is a PR or a comment on a PR.
    if: github.event_name == 'pull_request' || github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      # This permission is required to read checks and comments.
      checks: 'read'
      contents: 'read'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: gcs-aiml-clients-testing-101
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true


      - name: Get trigger ID for amaloo-gcsfs-v2
        id: get_trigger_id
        if: contains(github.event.pull_request.labels.*.name, 'gcb-perf')
        run: |
          TRIGGER_ID=$(gcloud beta builds triggers list --filter="name:amaloo-gcsfs-v2" --region=us-central1 --format="value(id)")
          echo "TRIGGER_ID=$TRIGGER_ID" >> $GITHUB_ENV
        env:
          PROJECT_ID: gcs-aiml-clients-testing-101

      - name: Find the latest Cloud Build ID
        id: find_build
        if: contains(github.event.pull_request.labels.*.name, 'gcb-perf') && steps.get_trigger_id.outputs.TRIGGER_ID
        run: |
          BUILD_ID=$(gcloud builds list --region=us-central1 --filter="trigger_id=${{ env.TRIGGER_ID }} AND substitutions.BRANCH_NAME=${{ github.head_ref }}" --limit=1 --sort-by=~createTime --format="value(id)")
          if [[ -z "$BUILD_ID" ]]; then
            echo "No build found for trigger ${{ env.TRIGGER_ID }} on branch ${{ github.head_ref }}"
            exit 1
          fi
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "Found Cloud Build ID: $BUILD_ID"
        env:
          PROJECT_ID: gcs-aiml-clients-testing-101

      - name: Wait for Cloud Build to complete
        if: contains(github.event.pull_request.labels.*.name, 'gcb-perf') && steps.find_build.outputs.BUILD_ID
        run: |
          echo "Waiting for build ${{ env.BUILD_ID }} to complete..."
          while true;
            do
            BUILD_STATUS=$(gcloud builds describe ${{ env.BUILD_ID }} --region=us-central1 --format=json | jq -r '.status')
            echo "Current build status: $BUILD_STATUS"
            if [[ "$BUILD_STATUS" != "PENDING" && "$BUILD_STATUS" != "QUEUING" && "$BUILD_STATUS" != "WORKING" ]] ; then
              break
            fi
            sleep 30
          done
        env:
          PROJECT_ID: gcs-aiml-clients-testing-101

      - name: Check Cloud Build status
        if: contains(github.event.pull_request.labels.*.name, 'gcb-perf')
        run: |
          BUILD_STATUS=$(gcloud builds describe ${{ env.BUILD_ID }} --region=us-central1 --format=json | jq -r '.status')
          echo "Final build status: $BUILD_STATUS"
          if [[ "$BUILD_STATUS" != "SUCCESS" ]]; then
            echo "Cloud Build failed with status: $BUILD_STATUS"
            exit 1
          fi
        env:
          PROJECT_ID: gcs-aiml-clients-testing-101