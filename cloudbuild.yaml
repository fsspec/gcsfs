steps:

  # Step 0: Create a GCE VM to run the tests.
  # The VM is created in the same zone as the buckets to test zonal bucket features.
  # It's given the 'cloud-platform' scope to allow it to access GCS and other services.
  - name: "gcr.io/cloud-builders/gcloud"
    id: "create-vm"
    args:
      - "compute"
      - "instances"
      - "create"
      - "gcsfs-test-vm-1"
      - "--project=gcs-aiml-clients-testing-101"
      - "--zone=us-central1-b"
      - "--tags=allow-ssh"
      - "--machine-type=e2-medium"
      - "--image-family=debian-11"
      - "--image-project=debian-cloud"
      - "--service-account=369568738723-compute@developer.gserviceaccount.com"
      - "--scopes=https://www.googleapis.com/auth/cloud-platform" # Full access to project APIs
      - "--metadata=enable-oslogin=TRUE"
    waitFor: ["-"]

  # Step 1: SSH into the VM and clone the repository
  - name: "gcr.io/cloud-builders/gcloud"
    id: "ssh"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        set -e

        # Wait for the VM to be fully initialized and SSH to be ready.
        for i in {1..10}; do
          if gcloud compute ssh gcsfs-test-vm-1 --project gcs-aiml-clients-testing-101 --zone=us-central1-b --internal-ip --quiet --command="whoami" --tunnel-through-iap; then
            break
          fi
          echo "Waiting for VM to become available... (attempt $$i/10)"
          sleep 15
        done

        VM_SCRIPT="
          set -e
          echo "SSH complete
        "
        gcloud compute ssh gcsfs-test-vm-1 --project gcs-aiml-clients-testing-101 --zone=us-central1-b --internal-ip --quiet --command="$VM_SCRIPT" --tunnel-through-iap

    waitFor: ["create-vm"]

  # Step 2: Clone the private tessellations repository using the SSH key
  - name: 'gcr.io/cloud-builders/git'
    id: "clone"
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Create the .ssh directory before using it
        mkdir -p /root/.ssh

        # Set up SSH
        echo "$$SSH_KEY" > /root/.ssh/id_rsa
        chmod 400 /root/.ssh/id_rsa
        ssh-keyscan github.com > /root/.ssh/known_hosts

        # Clone the repository using the SSH URL
        git clone git@github.com:google-partners/tessellations.git
    secretEnv: ['SSH_KEY']

timeout: "1800s" # 60 minutes

options:
  logging: CLOUD_LOGGING_ONLY
  pool:
    name: "projects/${PROJECT_ID}/locations/us-central1/workerPools/cloud-build-worker-pool"

substitutions:
  _HEAD_BRANCH: ${HEAD_BRANCH}

availableSecrets:
  secretManager:
  - versionName: projects/gcs-aiml-clients-testing-101/secrets/github-deploy-key-tessellations-amaloo/versions/latest
    env: 'SSH_KEY'
