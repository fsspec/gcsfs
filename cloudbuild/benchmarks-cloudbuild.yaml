substitutions:
  _PROJECT_ID: "gcs-aiml-clients-testing-101"
  _LOCATION: "us-central1"
  _ZONE: "us-central1-a"
  _BUCKET_PREFIX: "gcsfs-perf"
  _SERVICE_ACCOUNT: "gcsfs-zonal-vm-sc@gcs-aiml-clients-testing-101.iam.gserviceaccount.com"
  _SKIP_STEPS: ""
  # Fanout Configuration: Space-separated list of "group:config_name" or "group:" (for all configs in group).
  # Example: "read:read_seq,read_rand write: listing:"
  _BENCHMARK_FANOUT_CONFIG: "read:read_seq,read_rand read:read_seq_multi_process,read_rand_multi_process write:write_seq,write_seq_multi_process listing: delete: rename:"

steps:
  # 1. Generate a persistent SSH key for this build run.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "generate-ssh-key"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        mkdir -p /workspace/.ssh
        ssh-keygen -t rsa -f /workspace/.ssh/google_compute_engine -N '' -C gcb
        cat /workspace/.ssh/google_compute_engine.pub > /workspace/gcb_ssh_key.pub
    waitFor: ["-"]

  # 2. Initialize shared variables.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "init-variables"
    entrypoint: "bash"
    env:
      - "BUILD_ID=${BUILD_ID}"
    args:
      - "-c"
      - |
        SHORT_BUILD_ID=$${BUILD_ID:0:8}
        # Define shared variables
        echo "export PROJECT_ID=${_PROJECT_ID}" > /workspace/build_vars.env
        echo "export ZONE=${_ZONE}" >> /workspace/build_vars.env
        echo "export BENCHMARK_FANOUT_CONFIG=${_BENCHMARK_FANOUT_CONFIG}" >> /workspace/build_vars.env
        echo "export RUN_ID=$${BUILD_ID}" >> /workspace/build_vars.env
        echo "export SHORT_BUILD_ID=$${SHORT_BUILD_ID}" >> /workspace/build_vars.env
        echo "export REGIONAL_BUCKET=${_BUCKET_PREFIX}-regional-$${SHORT_BUILD_ID}" >> /workspace/build_vars.env
        echo "export ZONAL_BUCKET=${_BUCKET_PREFIX}-zonal-$${SHORT_BUILD_ID}" >> /workspace/build_vars.env
        echo "export HNS_BUCKET=${_BUCKET_PREFIX}-hns-$${SHORT_BUILD_ID}" >> /workspace/build_vars.env
        echo "export RESULTS_BUCKET=${_BUCKET_PREFIX}-results-${_PROJECT_ID}" >> /workspace/build_vars.env
        echo "export TEMPLATE_NAME='gcsfs-perf-tmpl-$${SHORT_BUILD_ID}'" >> /workspace/build_vars.env
        echo "export MIG_NAME='gcsfs-perf-mig-$${SHORT_BUILD_ID}'" >> /workspace/build_vars.env
    waitFor: ["-"]

  # 3. Create all necessary GCS buckets in parallel.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "create-buckets"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [[ ",${_SKIP_STEPS}," == *",create-buckets,"* ]]; then
          echo "--- Skipping step: create-buckets ---"
          exit 0
        fi
        set -e
        source /workspace/build_vars.env

        # Create Test Buckets, in parallel
        gcloud storage buckets create gs://$$REGIONAL_BUCKET --project=${_PROJECT_ID} --location=${_LOCATION} &
        gcloud storage buckets create gs://$$ZONAL_BUCKET --project=${_PROJECT_ID} --location=${_LOCATION} --placement=${_ZONE} --default-storage-class=RAPID --enable-hierarchical-namespace --uniform-bucket-level-access &
        gcloud storage buckets create gs://$$HNS_BUCKET --project=${_PROJECT_ID} --location=${_LOCATION} --enable-hierarchical-namespace --uniform-bucket-level-access &

        # Create HNS Results Bucket (Persistent)
        if ! gcloud storage buckets describe gs://$$RESULTS_BUCKET --project=${_PROJECT_ID} >/dev/null 2>&1; then
          gcloud storage buckets create gs://$$RESULTS_BUCKET --project=${_PROJECT_ID} --location=${_LOCATION} --enable-hierarchical-namespace --uniform-bucket-level-access &
        else
          echo "--- Results bucket gs://$${RESULTS_BUCKET} already exists ---"
        fi

        wait
    waitFor: ["init-variables"]

  # 4. Calculate number of VMs needed.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "count-configs"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        IFS=' ' read -r -a CONFIG_ARRAY <<< "${_BENCHMARK_FANOUT_CONFIG}"
        echo "export NUM_VMS=$${#CONFIG_ARRAY[@]}" >> /workspace/build_vars.env
        echo "Calculated NUM_VMS: $${#CONFIG_ARRAY[@]}"
    waitFor: ["init-variables"]

  # 5. Create Instance Group based on count.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "create-mig"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [[ ",${_SKIP_STEPS}," == *",create-mig,"* ]]; then
          echo "--- Skipping step: create-mig ---"
          exit 0
        fi
        set -e
        source /workspace/build_vars.env

        echo "Creating Instance Template: $${TEMPLATE_NAME}"
        gcloud compute instance-templates create "$$TEMPLATE_NAME" \
            --project="${_PROJECT_ID}" \
            --machine-type="c4-standard-192" \
            --image-family="ubuntu-2204-lts" \
            --image-project="ubuntu-os-cloud" \
            --boot-disk-type="hyperdisk-balanced" \
            --boot-disk-size="100GB" \
            --network-interface="network-tier=PREMIUM,nic-type=GVNIC" \
            --network-performance-configs="total-egress-bandwidth-tier=TIER_1" \
            --scopes="https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/devstorage.read_write" \
            --metadata="enable-oslogin=TRUE" \
            --service-account="${_SERVICE_ACCOUNT}" \
            --tags="allow-ssh" \
            --labels="build-id=$$SHORT_BUILD_ID" \
            --quiet

        echo "Creating Managed Instance Group: $${MIG_NAME} with size $$NUM_VMS"
        gcloud compute instance-groups managed create "$$MIG_NAME" \
            --project="${_PROJECT_ID}" \
            --zone="${_ZONE}" \
            --template="$$TEMPLATE_NAME" \
            --size="$$NUM_VMS" \
            --quiet

        echo "Waiting for Instance Group to be stable..."
        gcloud compute instance-groups managed wait-until "$$MIG_NAME" \
            --project="${_PROJECT_ID}" \
            --zone="${_ZONE}" \
            --stable \
            --quiet

        # Save instance names for the next step
        gcloud compute instance-groups managed list-instances "$$MIG_NAME" \
            --project="${_PROJECT_ID}" \
            --zone="${_ZONE}" \
            --format="value(name)" > /workspace/instances.txt
    waitFor: ["count-configs"]

  # 6. Run Benchmarks.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "run-benchmarks"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [[ ",${_SKIP_STEPS}," == *",run-benchmarks,"* ]]; then
          echo "--- Skipping step: run-benchmarks ---"
          exit 0
        fi
        bash cloudbuild/run_benchmarks.sh
    waitFor:
      - "create-mig"
      - "create-buckets"
      - "generate-ssh-key"

  # --- Cleanup Steps ---

  # Clean up the SSH key.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "cleanup-ssh-key"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "--- Removing SSH key from OS Login profile ---"
        gcloud compute os-login ssh-keys remove \
          --key-file=/workspace/gcb_ssh_key.pub || true
    waitFor:
      - "run-benchmarks"

  # Delete MIG and Template.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "cleanup-mig"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [[ ",${_SKIP_STEPS}," == *",cleanup-mig,"* ]]; then
          echo "--- Skipping step: cleanup-mig ---"
          exit 0
        fi
        source /workspace/build_vars.env

        gcloud compute instance-groups managed delete "$$MIG_NAME" \
            --project="${_PROJECT_ID}" \
            --zone="${_ZONE}" \
            --quiet || true

        gcloud compute instance-templates delete "$$TEMPLATE_NAME" \
            --project="${_PROJECT_ID}" \
            --quiet || true
    waitFor:
      - "cleanup-ssh-key"

  # Delete all GCS buckets.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "delete-buckets"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [[ ",${_SKIP_STEPS}," == *",delete-buckets,"* ]]; then
          echo "--- Skipping step: delete-buckets ---"
          exit 0
        fi
        set -e
        source /workspace/build_vars.env

        # Delete Test Buckets, in parallel
        gcloud storage rm --recursive gs://$$REGIONAL_BUCKET &
        gcloud storage rm --recursive gs://$$ZONAL_BUCKET &
        gcloud storage rm --recursive gs://$$HNS_BUCKET &
        wait
    waitFor:
      - "run-benchmarks"

timeout: "7200s" # 2 hours

options:
  logging: CLOUD_LOGGING_ONLY
  pool:
    name: "projects/${_PROJECT_ID}/locations/${_LOCATION}/workerPools/cloud-build-worker-pool"
